---
import BaseLayout from "../layouts/BaseLayout.astro";

const title = "Find Trainers - FitProFinder";
const description =
  "Search and filter fitness trainers by location, specialty, and more.";
---

<BaseLayout title={title} description={description}>
  <!-- Search Hero Section -->
  <div class='bg-gradient-to-r from-blue-600 to-purple-700 text-white py-16'>
    <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
      <div class='text-center'>
        <h1 class='text-4xl font-bold mb-4'>Find Your Perfect Trainer</h1>
        <p class='text-xl mb-8 text-blue-100'>
          Connect with certified fitness professionals in your area
        </p>

        <!-- Main Search Bar -->
        <div class='max-w-2xl mx-auto'>
          <div class='flex flex-col sm:flex-row gap-4'>
            <div class='flex-1'>
              <input
                type='text'
                id='searchInput'
                placeholder='Search by name, specialty, or location...'
                class='w-full px-4 py-3 rounded-lg border-2 border-white/30 bg-white/95 text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-white focus:border-white shadow-lg backdrop-blur-sm'
              />
            </div>
            <button
              id='searchBtn'
              class='px-8 py-3 bg-white text-blue-600 font-semibold rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-white transition-colors shadow-lg'
            >
              Search
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Results Section -->
  <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12'>
    <div class='flex flex-col lg:flex-row gap-8'>
      <!-- Filters Sidebar -->
      <div class='lg:w-1/4'>
        <div class='bg-white rounded-lg shadow-sm border p-6 sticky top-4'>
          <h3 class='text-lg font-semibold text-gray-900 mb-4'>Filters</h3>

          <!-- Location Filter -->
          <div class='mb-6'>
            <label class='block text-sm font-medium text-gray-700 mb-2'
              >Location</label
            >
            <div class='space-y-2'>
              <input
                type='text'
                id='cityFilter'
                placeholder='City'
                class='w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
              />
              <select
                id='stateFilter'
                class='w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
              >
                <option value=''>All States</option>
                <option value='CA'>California</option>
                <option value='TX'>Texas</option>
                <option value='WA'>Washington</option>
                <option value='NY'>New York</option>
                <option value='FL'>Florida</option>
              </select>
            </div>
          </div>

          <!-- Specialty Filter -->
          <div class='mb-6'>
            <label class='block text-sm font-medium text-gray-700 mb-2'
              >Specialty</label
            >
            <select
              id='specialtyFilter'
              class='w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
            >
              <option value=''>All Specialties</option>
              <!-- Will be populated by JavaScript -->
            </select>
          </div>

          <!-- Rating Filter -->
          <div class='mb-6'>
            <label class='block text-sm font-medium text-gray-700 mb-2'
              >Minimum Rating</label
            >
            <select
              id='ratingFilter'
              class='w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
            >
              <option value=''>Any Rating</option>
              <option value='4.5'>4.5+ Stars</option>
              <option value='4.0'>4.0+ Stars</option>
              <option value='3.5'>3.5+ Stars</option>
            </select>
          </div>

          <!-- Session Type Filter -->
          <div class='mb-6'>
            <label class='block text-sm font-medium text-gray-700 mb-2'
              >Session Type</label
            >
            <div class='space-y-2'>
              <label class='flex items-center'>
                <input
                  type='checkbox'
                  id='onlineFilter'
                  class='rounded border-gray-300 text-blue-600 focus:ring-blue-500'
                />
                <span class='ml-2 text-sm text-gray-600'>Online Sessions</span>
              </label>
              <label class='flex items-center'>
                <input
                  type='checkbox'
                  id='inPersonFilter'
                  class='rounded border-gray-300 text-blue-600 focus:ring-blue-500'
                />
                <span class='ml-2 text-sm text-gray-600'
                  >In-Person Sessions</span
                >
              </label>
            </div>
          </div>

          <!-- Verified Filter -->
          <div class='mb-6'>
            <label class='flex items-center'>
              <input
                type='checkbox'
                id='verifiedFilter'
                class='rounded border-gray-300 text-blue-600 focus:ring-blue-500'
              />
              <span class='ml-2 text-sm text-gray-600'
                >Verified Trainers Only</span
              >
            </label>
          </div>

          <!-- Clear Filters -->
          <button
            id='clearFilters'
            class='w-full px-4 py-2 text-sm text-blue-600 border border-blue-600 rounded-md hover:bg-blue-50 transition-colors'
          >
            Clear All Filters
          </button>
        </div>
      </div>

      <!-- Results Section -->
      <div class='lg:w-3/4'>
        <!-- Results Header -->
        <div class='flex justify-between items-center mb-6'>
          <div>
            <h2 class='text-2xl font-bold text-gray-900'>Trainers Near You</h2>
            <p id='resultsCount' class='text-gray-600'>Loading...</p>
          </div>
          <div class='flex items-center space-x-4'>
            <label class='text-sm text-gray-700'>Sort by:</label>
            <select
              id='sortBy'
              class='px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
            >
              <option value='rating'>Highest Rated</option>
              <option value='reviews'>Most Reviews</option>
              <option value='experience'>Most Experience</option>
            </select>
          </div>
        </div>

        <!-- Loading State -->
        <div id='loadingState' class='text-center py-12'>
          <div
            class='animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto'
          >
          </div>
          <p class='mt-4 text-gray-600'>Finding trainers...</p>
        </div>

        <!-- Results Grid -->
        <div
          id='trainersGrid'
          class='hidden grid grid-cols-1 md:grid-cols-2 gap-6'
        >
          <!-- Trainer cards will be inserted here by JavaScript -->
        </div>

        <!-- No Results State -->
        <div id='noResults' class='hidden text-center py-12'>
          <div class='text-gray-400 mb-4'>
            <svg
              class='w-16 h-16 mx-auto'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path
                stroke-linecap='round'
                stroke-linejoin='round'
                stroke-width='2'
                d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'></path>
            </svg>
          </div>
          <h3 class='text-xl font-medium text-gray-900 mb-2'>
            No trainers found
          </h3>
          <p class='text-gray-600'>
            Try adjusting your search criteria or location.
          </p>
        </div>

        <!-- Pagination -->
        <div
          id='pagination'
          class='hidden mt-12 flex justify-center items-center space-x-4'
        >
          <button
            id='prevPage'
            class='px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed'
          >
            Previous
          </button>
          <span id='pageInfo' class='text-sm text-gray-700'></span>
          <button
            id='nextPage'
            class='px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed'
          >
            Next
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  class TrainerSearch {
    constructor() {
      this.currentPage = 1;
      this.currentFilters = {};
      this.specialties = [];
      this.init();
    }

    async init() {
      await this.loadSpecialties();
      await this.searchTrainers();
      this.setupEventListeners();
    }

    async loadSpecialties() {
      // Check if we're in production (no localhost backend)
      const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';

      if (isProduction) {
        console.log("Production environment detected, using mock specialties data");
        this.specialties = [
          { id: 1, name: "Personal Training", slug: "personal-training" },
          { id: 2, name: "Yoga", slug: "yoga" },
          { id: 3, name: "Nutrition Coaching", slug: "nutrition-coaching" },
          { id: 4, name: "Strength Training", slug: "strength-training" },
          { id: 5, name: "Pilates", slug: "pilates" },
          { id: 6, name: "Cardio Training", slug: "cardio-training" },
          { id: 7, name: "HIIT", slug: "hiit" },
          { id: 8, name: "Weight Loss", slug: "weight-loss" },
          { id: 9, name: "Sports Performance", slug: "sports-performance" },
          { id: 10, name: "Boxing", slug: "boxing" },
          { id: 11, name: "CrossFit", slug: "crossfit" },
          { id: 12, name: "Meditation", slug: "meditation" }
        ];
        this.populateSpecialtyFilter();
        return;
      }

      try {
        const response = await fetch(
          "http://localhost:3000/api/specialties"
        );
        const data = await response.json();
        if (data.success) {
          this.specialties = data.data;
          this.populateSpecialtyFilter();
        }
      } catch (error) {
        console.log("API not available, using mock specialties data");
        // Mock specialties data for production
        this.specialties = [
          { id: 1, name: "Personal Training", slug: "personal-training" },
          { id: 2, name: "Yoga", slug: "yoga" },
          { id: 3, name: "Nutrition Coaching", slug: "nutrition-coaching" },
          { id: 4, name: "Strength Training", slug: "strength-training" },
          { id: 5, name: "Pilates", slug: "pilates" },
          { id: 6, name: "Cardio Training", slug: "cardio-training" },
          { id: 7, name: "HIIT", slug: "hiit" },
          { id: 8, name: "Weight Loss", slug: "weight-loss" },
          { id: 9, name: "Sports Performance", slug: "sports-performance" },
          { id: 10, name: "Boxing", slug: "boxing" },
          { id: 11, name: "CrossFit", slug: "crossfit" },
          { id: 12, name: "Meditation", slug: "meditation" }
        ];
        this.populateSpecialtyFilter();
      }
    }

    populateSpecialtyFilter() {
      const specialtyFilter = document.getElementById("specialtyFilter");
      if (specialtyFilter && this.specialties) {
        this.specialties.forEach((specialty) => {
          const option = document.createElement("option");
          option.value = specialty.id;
          option.textContent = specialty.name;
          specialtyFilter.appendChild(option);
        });
      }
    }

    setupEventListeners() {
      // Search button and input
      const searchBtn = document.getElementById("searchBtn");
      const searchInput = document.getElementById("searchInput");

      if (searchBtn)
        searchBtn.addEventListener("click", () => this.handleSearch());
      if (searchInput) {
        searchInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") this.handleSearch();
        });
      }

      // Filters
      ["cityFilter", "stateFilter", "specialtyFilter", "ratingFilter"].forEach(
        (id) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("change", () => this.handleFilterChange());
          }
        }
      );

      ["onlineFilter", "inPersonFilter", "verifiedFilter"].forEach((id) => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener("change", () => this.handleFilterChange());
        }
      });

      // Clear filters
      const clearBtn = document.getElementById("clearFilters");
      if (clearBtn)
        clearBtn.addEventListener("click", () => this.clearFilters());

      // Sort
      const sortBy = document.getElementById("sortBy");
      if (sortBy) sortBy.addEventListener("change", () => this.handleSearch());

      // Pagination
      const prevBtn = document.getElementById("prevPage");
      const nextBtn = document.getElementById("nextPage");
      if (prevBtn) prevBtn.addEventListener("click", () => this.previousPage());
      if (nextBtn) nextBtn.addEventListener("click", () => this.nextPage());
    }

    handleSearch() {
      this.currentPage = 1;
      this.searchTrainers();
    }

    handleFilterChange() {
      this.currentPage = 1;
      this.searchTrainers();
    }

    clearFilters() {
      const elements = [
        "searchInput",
        "cityFilter",
        "stateFilter",
        "specialtyFilter",
        "ratingFilter",
      ];
      elements.forEach((id) => {
        const element = document.getElementById(id);
        if (element) element.value = "";
      });

      const checkboxes = ["onlineFilter", "inPersonFilter", "verifiedFilter"];
      checkboxes.forEach((id) => {
        const element = document.getElementById(id);
        if (element) element.checked = false;
      });

      this.handleSearch();
    }

    getSearchParams() {
      const params = new URLSearchParams();

      const searchInput = document.getElementById("searchInput");
      const search = searchInput ? searchInput.value.trim() : "";
      if (search) params.append("search", search);

      const cityFilter = document.getElementById("cityFilter");
      const city = cityFilter ? cityFilter.value.trim() : "";
      if (city) params.append("city", city);

      const stateFilter = document.getElementById("stateFilter");
      const state = stateFilter ? stateFilter.value : "";
      if (state) params.append("state", state);

      const specialtyFilter = document.getElementById("specialtyFilter");
      const specialty = specialtyFilter ? specialtyFilter.value : "";
      if (specialty) params.append("specialty", specialty);

      const ratingFilter = document.getElementById("ratingFilter");
      const rating = ratingFilter ? ratingFilter.value : "";
      if (rating) params.append("min_rating", rating);

      const onlineFilter = document.getElementById("onlineFilter");
      if (onlineFilter && onlineFilter.checked) {
        params.append("online_sessions", "true");
      }

      const inPersonFilter = document.getElementById("inPersonFilter");
      if (inPersonFilter && inPersonFilter.checked) {
        params.append("in_person_sessions", "true");
      }

      const verifiedFilter = document.getElementById("verifiedFilter");
      if (verifiedFilter && verifiedFilter.checked) {
        params.append("verified_only", "true");
      }

      params.append("page", this.currentPage.toString());
      params.append("limit", "12");

      return params;
    }

    async searchTrainers() {
      this.showLoading();

      // More robust production detection
      const isProduction = window.location.hostname !== 'localhost' && 
                          window.location.hostname !== '127.0.0.1' &&
                          !window.location.hostname.includes('localhost') &&
                          !window.location.hostname.includes('127.0.0.1');

      const isNetlify = window.location.hostname.includes('netlify.app');
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      console.log("Environment check:", {
        hostname: window.location.hostname,
        isProduction: isProduction,
        isNetlify: isNetlify,
        isMobile: isMobile,
        protocol: window.location.protocol,
        userAgent: navigator.userAgent
      });
      
      if (isProduction || isNetlify) {
        console.log("Production/Netlify environment detected, using mock data");
        const mockData = this.getMockTrainersData();
        console.log("Mock data structure:", mockData);
        console.log("Mock trainers count:", mockData.data?.trainers?.length);
        this.displayResults(mockData);
        return;
      }

      try {
        const params = this.getSearchParams();
        const response = await fetch(
          `http://localhost:3000/api/trainers?${params}`
        );
        const data = await response.json();

        if (data.success) {
          this.displayResults(data);
        } else {
          throw new Error(data.error?.message || "Search failed");
        }
      } catch (error) {
        console.log("API not available, using mock trainers data");
        console.log("Error:", error);
        // Mock trainers data for production
        const mockData = this.getMockTrainersData();
        console.log("Fallback mock data structure:", mockData);
        console.log("Fallback mock trainers count:", mockData.data?.trainers?.length);
        this.displayResults(mockData);
      }
    }

    // Always ensure trainers are shown - fallback method
    ensureTrainersDisplay() {
      console.log("Ensuring trainers are displayed...");
      const resultsContainer = document.getElementById('results');
      if (resultsContainer && resultsContainer.children.length === 0) {
        console.log("No trainers found, forcing mock data display");
        this.forceMockData();
      }
    }

    // Force mock data for Netlify deployment
    forceMockData() {
      console.log("Forcing mock data for Netlify deployment");
      const mockData = this.getMockTrainersData();
      console.log("Forced mock data:", mockData);
      this.displayResults(mockData);
    }

    getMockTrainersData() {
      // Mock trainers data that matches the API response format
      const mockTrainers = [
        {
          id: 1,
          name: "Sarah Johnson",
          businessName: "Sarah Johnson Fitness",
          bio: "Certified personal trainer with 8 years of experience helping clients achieve their fitness goals through personalized strength training and weight loss programs.",
          profileImageUrl: "https://images.unsplash.com/photo-1594824388852-8a7b3b4b8b8b?w=400&h=400&fit=crop&crop=face",
          rating: 4.8,
          reviewCount: 42,
          specialties: ["Personal Training", "Weight Loss", "Strength Training"],
          location: { city: "Los Angeles", state: "CA" },
          experienceYears: 8,
          verified: true,
          offersOnline: true,
          offersInPerson: true,
          priceRange: { min: 60, max: 120 }
        },
        {
          id: 2,
          name: "Mike Chen",
          businessName: "Zen Yoga Studio",
          bio: "Experienced yoga instructor and wellness coach helping people find balance through mindful movement and meditation practices.",
          profileImageUrl: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop&crop=face",
          rating: 4.9,
          reviewCount: 38,
          specialties: ["Yoga", "Meditation", "Pilates"],
          location: { city: "San Francisco", state: "CA" },
          experienceYears: 6,
          verified: true,
          offersOnline: true,
          offersInPerson: true,
          priceRange: { min: 45, max: 90 }
        },
        {
          id: 3,
          name: "Jessica Rodriguez",
          businessName: "NutriCore Coaching",
          bio: "Registered dietitian and certified nutrition coach specializing in sustainable weight loss and performance nutrition for athletes.",
          profileImageUrl: "https://images.unsplash.com/photo-1494790108755-2616b612b786?w=400&h=400&fit=crop&crop=face",
          rating: 4.7,
          reviewCount: 29,
          specialties: ["Nutrition Coaching", "Weight Loss", "Sports Nutrition"],
          location: { city: "Austin", state: "TX" },
          experienceYears: 5,
          verified: true,
          offersOnline: true,
          offersInPerson: false,
          priceRange: { min: 80, max: 150 }
        },
        {
          id: 4,
          name: "Alex Thompson",
          businessName: "HIIT Zone Miami",
          bio: "High-intensity interval training specialist and former military fitness instructor. Expert in fat burning and cardiovascular conditioning.",
          profileImageUrl: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop&crop=face",
          rating: 4.6,
          reviewCount: 56,
          specialties: ["HIIT", "Cardio", "Military Fitness"],
          location: { city: "Miami", state: "FL" },
          experienceYears: 10,
          verified: true,
          offersOnline: true,
          offersInPerson: true,
          priceRange: { min: 50, max: 100 }
        },
        {
          id: 5,
          name: "David Wilson",
          businessName: "Peak Performance Lab",
          bio: "Sports performance coach working with professional athletes and weekend warriors. Specializing in functional movement and injury prevention.",
          profileImageUrl: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=400&fit=crop&crop=face",
          rating: 4.9,
          reviewCount: 73,
          specialties: ["Sports Performance", "Strength Training", "Injury Prevention"],
          location: { city: "Denver", state: "CO" },
          experienceYears: 12,
          verified: true,
          offersOnline: false,
          offersInPerson: true,
          priceRange: { min: 100, max: 200 }
        },
        {
          id: 6,
          name: "Lisa Martinez",
          businessName: "Recovery & Wellness Center",
          bio: "Physical therapist and corrective exercise specialist helping clients recover from injuries and improve movement quality.",
          profileImageUrl: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=400&fit=crop&crop=face",
          rating: 4.8,
          reviewCount: 34,
          specialties: ["Injury Recovery", "Corrective Exercise", "Physical Therapy"],
          location: { city: "Seattle", state: "WA" },
          experienceYears: 7,
          verified: true,
          offersOnline: true,
          offersInPerson: true,
          priceRange: { min: 90, max: 180 }
        }
      ];

      // Apply filters to mock data
      let filteredTrainers = [...mockTrainers];
      const searchTerm = document.getElementById("searchInput")?.value.toLowerCase() || "";
      const specialtyFilter = document.getElementById("specialtyFilter")?.value || "";
      const cityFilter = document.getElementById("cityFilter")?.value.toLowerCase() || "";
      const stateFilter = document.getElementById("stateFilter")?.value.toLowerCase() || "";
      const ratingFilter = document.getElementById("ratingFilter")?.value || "";
      const onlineFilter = document.getElementById("onlineFilter")?.checked || false;
      const inPersonFilter = document.getElementById("inPersonFilter")?.checked || false;
      const verifiedFilter = document.getElementById("verifiedFilter")?.checked || false;

      console.log("Mock data filters:", {
        searchTerm,
        specialtyFilter,
        cityFilter,
        stateFilter,
        ratingFilter,
        onlineFilter,
        inPersonFilter,
        verifiedFilter,
        totalTrainers: mockTrainers.length
      });

      // Apply search term filter
      if (searchTerm) {
        filteredTrainers = filteredTrainers.filter(trainer =>
          trainer.name.toLowerCase().includes(searchTerm) ||
          trainer.businessName.toLowerCase().includes(searchTerm) ||
          trainer.bio.toLowerCase().includes(searchTerm) ||
          trainer.specialties.some(s => s.toLowerCase().includes(searchTerm)) ||
          trainer.location.city.toLowerCase().includes(searchTerm) ||
          trainer.location.state.toLowerCase().includes(searchTerm)
        );
      }

      // Apply specialty filter
      if (specialtyFilter) {
        filteredTrainers = filteredTrainers.filter(trainer =>
          trainer.specialties.some(s => s === specialtyFilter)
        );
      }

      // Apply location filters
      if (cityFilter) {
        filteredTrainers = filteredTrainers.filter(trainer =>
          trainer.location.city.toLowerCase().includes(cityFilter)
        );
      }
      if (stateFilter) {
        filteredTrainers = filteredTrainers.filter(trainer =>
          trainer.location.state.toLowerCase().includes(stateFilter)
        );
      }

      // Apply rating filter
      if (ratingFilter) {
        const minRating = parseFloat(ratingFilter);
        filteredTrainers = filteredTrainers.filter(trainer =>
          trainer.rating >= minRating
        );
      }

      // Apply session type filters
      if (onlineFilter) {
        filteredTrainers = filteredTrainers.filter(trainer => trainer.offersOnline);
      }
      if (inPersonFilter) {
        filteredTrainers = filteredTrainers.filter(trainer => trainer.offersInPerson);
      }

      // Apply verified filter
      if (verifiedFilter) {
        filteredTrainers = filteredTrainers.filter(trainer => trainer.verified);
      }

      // Pagination
      const startIndex = (this.currentPage - 1) * 12;
      const endIndex = startIndex + 12;
      const paginatedTrainers = filteredTrainers.slice(startIndex, endIndex);

      console.log("Mock data results:", {
        totalTrainers: mockTrainers.length,
        filteredTrainers: filteredTrainers.length,
        paginatedTrainers: paginatedTrainers.length,
        currentPage: this.currentPage,
        startIndex,
        endIndex
      });

      return {
        success: true,
        data: {
          trainers: paginatedTrainers,
          pagination: {
            currentPage: this.currentPage,
            totalPages: Math.ceil(filteredTrainers.length / 12),
            totalCount: filteredTrainers.length,
            hasNextPage: endIndex < filteredTrainers.length,
            hasPrevPage: this.currentPage > 1,
            limit: 12
          }
        }
      };
    }

    showLoading() {
      const loadingState = document.getElementById("loadingState");
      const trainersGrid = document.getElementById("trainersGrid");
      const noResults = document.getElementById("noResults");
      const pagination = document.getElementById("pagination");

      if (loadingState) loadingState.classList.remove("hidden");
      if (trainersGrid) trainersGrid.classList.add("hidden");
      if (noResults) noResults.classList.add("hidden");
      if (pagination) pagination.classList.add("hidden");
    }

    displayResults(data) {
      console.log("displayResults called with data:", data);
      const trainers = data.data || [];
      const pagination = data.pagination || {};
      console.log("trainers:", trainers, "pagination:", pagination);

      const loadingState = document.getElementById("loadingState");
      if (loadingState) loadingState.classList.add("hidden");

      // Update results count
      const resultsCount = document.getElementById("resultsCount");
      if (resultsCount) {
        const totalCount = pagination?.totalCount || trainers?.length || 0;
        resultsCount.textContent = `${totalCount} trainer${totalCount !== 1 ? "s" : ""} found`;
      }

      if (!trainers || trainers.length === 0) {
        const noResults = document.getElementById("noResults");
        if (noResults) noResults.classList.remove("hidden");
        return;
      }

      // Display trainers
      const grid = document.getElementById("trainersGrid");
      if (grid) {
        grid.innerHTML = "";
        grid.classList.remove("hidden");

        trainers.forEach((trainer) => {
          grid.appendChild(this.createTrainerCard(trainer));
        });
      }

      // Update pagination
      this.updatePagination(pagination);
    }

    createTrainerCard(trainer) {
      const card = document.createElement("div");
      card.className =
        "bg-white rounded-lg shadow-sm border hover:shadow-md transition-shadow cursor-pointer";
      card.onclick = () => (window.location.href = `/trainers/${trainer.id}`);

      card.innerHTML = `
        <div class="p-6">
          <div class="flex items-start space-x-4">
            <img
              src="${trainer.profileImageUrl || trainer.profileImage || '/default-avatar.svg'}"
              alt="${trainer.name}"
              class="w-16 h-16 rounded-full object-cover"
            />
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">
                  ${trainer.name}
                  ${trainer.verified ? '<span class="text-blue-500 ml-1">✓</span>' : ""}
                </h3>
                <div class="flex items-center">
                  <span class="text-yellow-400">★</span>
                  <span class="text-sm font-medium text-gray-900 ml-1">${trainer.rating}</span>
                  <span class="text-sm text-gray-500 ml-1">(${trainer.reviewCount})</span>
                </div>
              </div>

              <p class="text-blue-600 font-medium text-sm">$${trainer.priceRange?.min || 'N/A'}/hour</p>
              <p class="text-gray-600 text-sm">${trainer.location.city}, ${trainer.location.state}</p>

              <p class="text-gray-700 text-sm mt-2 line-clamp-2">${trainer.bio}</p>

              <div class="flex flex-wrap gap-1 mt-3">
                ${trainer.specialties
                  .slice(0, 3)
                  .map(
                    (specialty) =>
                      `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${specialty}</span>`
                  )
                  .join("")}
                ${
                  trainer.specialties.length > 3
                    ? `<span class="text-xs text-gray-500">+${trainer.specialties.length - 3} more</span>`
                    : ""
                }
              </div>

              <div class="flex items-center justify-between mt-4">
                <div class="flex space-x-2 text-xs text-gray-600">
                  ${trainer.offersOnline ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded">Online</span>' : ''}
                  ${trainer.offersInPerson ? '<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">In-Person</span>' : ''}
                </div>
                <span class="text-sm text-gray-500">${trainer.experienceYears} years exp.</span>
              </div>
            </div>
          </div>
        </div>
      `;

      return card;
    }

    updatePagination(pagination) {
      const paginationEl = document.getElementById("pagination");
      const prevBtn = document.getElementById("prevPage");
      const nextBtn = document.getElementById("nextPage");
      const pageInfo = document.getElementById("pageInfo");

      if (pagination && pagination.totalPages > 1) {
        if (paginationEl) paginationEl.classList.remove("hidden");

        if (prevBtn) prevBtn.disabled = pagination.currentPage === 1;
        if (nextBtn) nextBtn.disabled = pagination.currentPage === pagination.totalPages;

        if (pageInfo)
          pageInfo.textContent = `Page ${pagination.currentPage} of ${pagination.totalPages}`;
      } else {
        if (paginationEl) paginationEl.classList.add("hidden");
      }
    }

    previousPage() {
      if (this.currentPage > 1) {
        this.currentPage--;
        this.searchTrainers();
      }
    }

    nextPage() {
      this.currentPage++;
      this.searchTrainers();
    }

    showError(message) {
      const loadingState = document.getElementById("loadingState");
      const trainersGrid = document.getElementById("trainersGrid");
      const noResults = document.getElementById("noResults");

      if (loadingState) loadingState.classList.add("hidden");
      if (trainersGrid) trainersGrid.classList.add("hidden");
      if (noResults) {
        noResults.classList.remove("hidden");
        const errorTitle = noResults.querySelector("h3");
        const errorMessage = noResults.querySelector("p");
        if (errorTitle) errorTitle.textContent = "Search Error";
        if (errorMessage) errorMessage.textContent = message;
      }
    }
  }

  // Initialize the search when the page loads
  document.addEventListener("DOMContentLoaded", () => {
    const searchInstance = new TrainerSearch();

    // Read URL parameters and populate form
    const urlParams = new URLSearchParams(window.location.search);

    // Populate form fields from URL parameters
    const searchInput = document.getElementById("searchInput");
    if (searchInput && urlParams.get("search")) {
      searchInput.value = urlParams.get("search");
    }

    const cityFilter = document.getElementById("cityFilter");
    if (cityFilter && urlParams.get("city")) {
      cityFilter.value = urlParams.get("city");
    }

    const stateFilter = document.getElementById("stateFilter");
    if (stateFilter && urlParams.get("state")) {
      stateFilter.value = urlParams.get("state");
    }

    const specialtyFilter = document.getElementById("specialtyFilter");
    if (
      specialtyFilter &&
      (urlParams.get("specialty") || urlParams.get("category"))
    ) {
      // Handle both 'specialty' and 'category' parameters for compatibility
      const specialtyValue =
        urlParams.get("specialty") || urlParams.get("category");

      // Wait a bit for specialties to load, then set the value
      setTimeout(() => {
        // Try to find exact match first
        const exactOption = Array.from(specialtyFilter.options).find(
          (option) =>
            option.textContent.toLowerCase() === specialtyValue.toLowerCase() ||
            option.value === specialtyValue
        );

        if (exactOption) {
          specialtyFilter.value = exactOption.value;
        } else {
          // Try partial match for mapped categories
          const categoryMap = {
            "personal-training": "Personal Training",
            yoga: "Yoga",
            nutrition: "Nutrition Coaching",
            "strength-training": "Strength Training",
            pilates: "Pilates",
            cardio: "Cardio Training",
          };

          const mappedValue = categoryMap[specialtyValue] || specialtyValue;
          const partialOption = Array.from(specialtyFilter.options).find(
            (option) =>
              option.textContent
                .toLowerCase()
                .includes(mappedValue.toLowerCase())
          );

          if (partialOption) {
            specialtyFilter.value = partialOption.value;
          }
        }
      }, 500);
    }

    const ratingFilter = document.getElementById("ratingFilter");
    if (
      ratingFilter &&
      (urlParams.get("rating") || urlParams.get("min_rating"))
    ) {
      ratingFilter.value =
        urlParams.get("rating") || urlParams.get("min_rating");
    }

    const onlineFilter = document.getElementById("onlineFilter");
    if (onlineFilter && urlParams.get("online_sessions") === "true") {
      onlineFilter.checked = true;
    }

    const inPersonFilter = document.getElementById("inPersonFilter");
    if (inPersonFilter && urlParams.get("in_person_sessions") === "true") {
      inPersonFilter.checked = true;
    }

    const verifiedFilter = document.getElementById("verifiedFilter");
    if (verifiedFilter && urlParams.get("verified_only") === "true") {
      verifiedFilter.checked = true;
    }

    // Trigger initial search after form is populated
    setTimeout(() => {
      // More robust detection for production environments
      const isProduction = window.location.hostname !== 'localhost' && 
                          window.location.hostname !== '127.0.0.1' &&
                          !window.location.hostname.includes('localhost');
      const isNetlify = window.location.hostname.includes('netlify.app');
      
      console.log("Initialization check:", {
        hostname: window.location.hostname,
        isProduction: isProduction,
        isNetlify: isNetlify
      });
      
      if (isProduction || isNetlify) {
        console.log("Production/Netlify detected, forcing mock data");
        searchInstance.forceMockData();
      } else {
        console.log("Local development, using API");
        searchInstance.searchTrainers();
      }
      
      // Additional fallback to ensure trainers are always shown
      setTimeout(() => {
        searchInstance.ensureTrainersDisplay();
      }, 500);
    }, 100);
  });
</script>
