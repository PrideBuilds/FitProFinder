---
import BaseLayout from "../layouts/BaseLayout.astro";
import { TokenManager, getCurrentUserRole } from "../utils/api.js";

// Check authentication using the proper token check
const hasToken =
  typeof window !== "undefined" ? TokenManager.getAccessToken() : null;

// For server-side rendering, we'll handle auth check on the client side
const pageTitle = "Messages - FitProFinder";
---

<BaseLayout title={pageTitle}>
  <!-- Custom styles for message layout -->
  <style>
    /* Message container styling */
    .messages-area {
      height: calc(100vh - 300px); /* Fixed height for scrolling */
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      gap: 1rem;
    }

    /* Message bubble styling */
    .message-bubble {
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      hyphens: auto;
      max-width: 100%;
      white-space: pre-wrap;
    }

    /* Message container wrapper */
    .message-wrapper {
      display: flex;
      width: 100%;
      margin-bottom: 1rem;
    }

    .message-wrapper.own-message {
      justify-content: flex-end;
    }

    .message-wrapper.other-message {
      justify-content: flex-start;
    }

    /* Message content container */
    .message-content-container {
      max-width: 70%;
      min-width: 0; /* Important for text overflow */
      display: flex;
      flex-direction: column;
    }

    /* Message content bubble */
    .message-content-bubble {
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: pre-wrap;
      max-width: 100%;
      box-sizing: border-box;
    }

    .message-content-bubble.own {
      background-color: #3b82f6;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }

    .message-content-bubble.other {
      background-color: #f3f4f6;
      color: #111827;
      border-bottom-left-radius: 0.25rem;
    }

    /* Scroll to bottom smooth animation */
    .messages-area {
      scroll-behavior: smooth;
    }

    /* Chat interface layout */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0; /* Important for flex children */
    }

    /* Chat header fixed height */
    .chat-header {
      flex-shrink: 0;
      height: auto;
      min-height: 4rem;
    }

    /* Chat input area fixed height */
    .chat-input-area {
      flex-shrink: 0;
      height: auto;
      min-height: 5rem;
    }

    /* Avatar styling */
    .message-avatar {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      flex-shrink: 0;
      margin: 0 0.5rem;
    }

    /* File attachments styling */
    .attachment-image {
      max-width: 100%;
      max-height: 16rem;
      height: auto;
      border-radius: 0.5rem;
      cursor: pointer;
      object-fit: cover;
      margin-top: 0.5rem;
    }

    .attachment-file {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 0;
      max-width: 100%;
    }

    .attachment-file a {
      color: inherit;
      text-decoration: underline;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      max-width: 100%;
    }
  </style>

  <div class='min-h-screen bg-gray-50'>
    <!-- Header -->
    <div class='bg-white border-b border-gray-200 sticky top-0 z-10'>
      <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
        <div class='flex items-center justify-between h-16'>
          <div class='flex items-center'>
            <h1 class='text-2xl font-bold text-gray-900'>Messages</h1>
          </div>
          <div class='flex items-center space-x-4'>
            <!-- Connection status indicator -->
            <div id='connection-status' class='flex items-center space-x-2'>
              <div
                id='status-indicator'
                class='w-2 h-2 bg-gray-400 rounded-full'
              >
              </div>
              <span id='status-text' class='text-sm text-gray-500'
                >Connecting...</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6'>
      <div
        class='bg-white rounded-lg shadow-sm border border-gray-200 h-[calc(100vh-140px)]'
      >
        <div class='flex h-full'>
          <!-- Conversations sidebar -->
          <div class='w-1/3 border-r border-gray-200 flex flex-col'>
            <!-- Search bar -->
            <div class='p-4 border-b border-gray-200'>
              <div class='relative'>
                <input
                  type='text'
                  id='conversation-search'
                  placeholder='Search conversations...'
                  class='w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                />
                <div
                  class='absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none'
                >
                  <svg
                    class='h-5 w-5 text-gray-400'
                    fill='none'
                    stroke='currentColor'
                    viewBox='0 0 24 24'
                  >
                    <path
                      stroke-linecap='round'
                      stroke-linejoin='round'
                      stroke-width='2'
                      d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Conversations list -->
            <div class='flex-1 overflow-y-auto'>
              <div id='conversations-list' class='divide-y divide-gray-200'>
                <!-- Loading state -->
                <div
                  id='conversations-loading'
                  class='p-4 text-center text-gray-500'
                >
                  <div
                    class='animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2'
                  >
                  </div>
                  Loading conversations...
                </div>

                <!-- Empty state -->
                <div
                  id='conversations-empty'
                  class='hidden p-8 text-center text-gray-500'
                >
                  <svg
                    class='mx-auto h-12 w-12 text-gray-400 mb-4'
                    fill='none'
                    stroke='currentColor'
                    viewBox='0 0 24 24'
                  >
                    <path
                      stroke-linecap='round'
                      stroke-linejoin='round'
                      stroke-width='2'
                      d='M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.955 8.955 0 01-4.126-.98L3 20l1.98-5.874A8.955 8.955 0 013 12c0-4.418 3.582-8 8-8s8 3.582 8 8z'
                    ></path>
                  </svg>
                  <h3 class='text-lg font-medium text-gray-900 mb-2'>
                    No conversations yet
                  </h3>
                  <p class='text-gray-500'>
                    Start a conversation with a trainer or client to get
                    started.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat area -->
          <div class='flex-1 flex flex-col'>
            <!-- Welcome state -->
            <div
              id='welcome-state'
              class='flex-1 flex items-center justify-center'
            >
              <div class='text-center'>
                <svg
                  class='mx-auto h-16 w-16 text-gray-400 mb-4'
                  fill='none'
                  stroke='currentColor'
                  viewBox='0 0 24 24'
                >
                  <path
                    stroke-linecap='round'
                    stroke-linejoin='round'
                    stroke-width='2'
                    d='M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.955 8.955 0 01-4.126-.98L3 20l1.98-5.874A8.955 8.955 0 013 12c0-4.418 3.582-8 8-8s8 3.582 8 8z'
                  ></path>
                </svg>
                <h3 class='text-xl font-medium text-gray-900 mb-2'>
                  Welcome to Messages
                </h3>
                <p class='text-gray-500'>
                  Select a conversation to start messaging
                </p>
              </div>
            </div>

            <!-- Chat interface (hidden by default) -->
            <div id='chat-interface' class='hidden chat-container'>
              <!-- Chat header -->
              <div class='chat-header p-4 border-b border-gray-200 bg-gray-50'>
                <div class='flex items-center justify-between'>
                  <div class='flex items-center space-x-3'>
                    <img
                      id='chat-avatar'
                      src=''
                      alt=''
                      class='w-10 h-10 rounded-full bg-gray-300'
                    />
                    <div>
                      <h3 id='chat-name' class='font-medium text-gray-900'></h3>
                      <div class='flex items-center space-x-2'>
                        <div
                          id='chat-online-status'
                          class='w-2 h-2 bg-gray-400 rounded-full'
                        >
                        </div>
                        <span
                          id='chat-status-text'
                          class='text-sm text-gray-500'>Offline</span
                        >
                        <span
                          id='typing-indicator'
                          class='hidden text-sm text-blue-500 italic'
                          >typing...</span
                        >
                      </div>
                    </div>
                  </div>
                  <div class='flex items-center space-x-2'>
                    <!-- Chat actions -->
                    <button
                      id='chat-info-btn'
                      class='p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100'
                    >
                      <svg
                        class='w-5 h-5'
                        fill='none'
                        stroke='currentColor'
                        viewBox='0 0 24 24'
                      >
                        <path
                          stroke-linecap='round'
                          stroke-linejoin='round'
                          stroke-width='2'
                          d='M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
                        ></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Messages area -->
              <div class='messages-area' id='messages-container'>
                <!-- Messages will be loaded here -->
              </div>

              <!-- Message input -->
              <div
                class='chat-input-area p-4 border-t border-gray-200 bg-white'
              >
                <div class='flex items-end space-x-3'>
                  <!-- File upload button -->
                  <button
                    id='file-upload-btn'
                    class='p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100'
                  >
                    <svg
                      class='w-5 h-5'
                      fill='none'
                      stroke='currentColor'
                      viewBox='0 0 24 24'
                    >
                      <path
                        stroke-linecap='round'
                        stroke-linejoin='round'
                        stroke-width='2'
                        d='M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13'
                      ></path>
                    </svg>
                  </button>

                  <!-- Message input -->
                  <div class='flex-1'>
                    <textarea
                      id='message-input'
                      placeholder='Type a message...'
                      rows='1'
                      class='w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none'
                    ></textarea>
                  </div>

                  <!-- Send button -->
                  <button
                    id='send-btn'
                    disabled
                    class='px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed'
                  >
                    <svg
                      class='w-5 h-5'
                      fill='none'
                      stroke='currentColor'
                      viewBox='0 0 24 24'
                    >
                      <path
                        stroke-linecap='round'
                        stroke-linejoin='round'
                        stroke-width='2'
                        d='M12 19l9 2-9-18-9 18 9-2zm0 0v-8'></path>
                    </svg>
                  </button>
                </div>

                <!-- File upload area (hidden) -->
                <input
                  type='file'
                  id='file-input'
                  multiple
                  accept='image/*,application/pdf,.doc,.docx,.txt'
                  class='hidden'
                />

                <!-- File preview area -->
                <div
                  id='file-preview'
                  class='hidden mt-3 p-3 bg-gray-50 rounded-lg'
                >
                  <div class='flex items-center justify-between mb-2'>
                    <span class='text-sm font-medium text-gray-700'
                      >Selected files:</span
                    >
                    <button
                      id='clear-files-btn'
                      class='text-sm text-red-600 hover:text-red-800'
                      >Clear all</button
                    >
                  </div>
                  <div id='file-list' class='space-y-2'></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Include the messaging JavaScript -->
  <script>
    // Client-side authentication check
    document.addEventListener("DOMContentLoaded", () => {
      // Check for access token
      const token = localStorage.getItem("fitpro_access_token");

      if (!token) {
        // No token found, redirect to login
        window.location.href =
          "/auth/login?redirect=" +
          encodeURIComponent(window.location.pathname);
        return;
      }

      // Get user role from token
      let userRole = null;
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        userRole = payload.role || null;
      } catch (error) {
        console.error("Invalid token format:", error);
        window.location.href =
          "/auth/login?redirect=" +
          encodeURIComponent(window.location.pathname);
        return;
      }

      console.log("User authenticated with role:", userRole);
    });
  </script>
  <script src='/src/scripts/messaging.ts' type='module'></script>
</BaseLayout>
